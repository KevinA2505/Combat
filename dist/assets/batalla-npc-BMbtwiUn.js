import*as s from"https://unpkg.com/three@0.179.1/build/three.module.js";import{OrbitControls as _}from"https://unpkg.com/three@0.179.1/examples/jsm/controls/OrbitControls.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const r of a)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function n(a){const r={};return a.integrity&&(r.integrity=a.integrity),a.referrerPolicy&&(r.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?r.credentials="include":a.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(a){if(a.ep)return;a.ep=!0;const r=n(a);fetch(a.href,r)}})();const u={terrainSize:100,obstacleDensity:.05,npcTypes:["guerrero","arquero","mago"],attributes:{guerrero:{vida:100,ataque:20,velocidad:3,defensa:10,rango:2.2,cadencia:.7},arquero:{vida:80,ataque:14,velocidad:3.4,defensa:5,rango:9,cadencia:1.2},mago:{vida:60,ataque:26,velocidad:2.8,defensa:0,rango:7,cadencia:1.6}},projectile:{speed:16,radius:.18}};let h,E,I,L,H,B,z=[],C=[],b=[],i={},q=!1,U=0,T=1,D=!1,V=42;function W(t){return function(){t|=0,t=t+1831565813|0;let e=Math.imul(t^t>>>15,1|t);return e=e+Math.imul(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296}}let A=W(V),c=null;function ee(){const e=Math.floor(u.terrainSize/2),n=Math.floor(u.terrainSize/2);c={cellSize:2,width:e,height:n,cells:Array.from({length:n},()=>Array.from({length:e},()=>({height:0,walkable:!0})))}}function k(t,e){typeof t=="object"&&(e=t.z,t=t.x);const n=Math.floor((t+u.terrainSize/2)/c.cellSize),o=Math.floor((e+u.terrainSize/2)/c.cellSize);return{x:s.MathUtils.clamp(n,0,c.width-1),z:s.MathUtils.clamp(o,0,c.height-1)}}function te(t,e){const n=t*c.cellSize-u.terrainSize/2+c.cellSize/2,o=e*c.cellSize-u.terrainSize/2+c.cellSize/2,a=c.cells[e]?.[t]?.height||0;return new s.Vector3(n,a+1.1,o)}function N(t,e){return!!(c.cells[e]&&c.cells[e][t]&&c.cells[e][t].walkable)}function O(t,e,n,o){return Math.hypot(n-t,o-e)}function R(t,e){if(!c)return null;const n=k(t),o=k(e);if(!N(o.x,o.z))return null;const a=[],r=new Set,l=(d,y)=>`${d},${y}`,f=new Map,m={x:n.x,z:n.z,g:0,h:O(n.x,n.z,o.x,o.z),f:0,parent:null};for(m.f=m.h,a.push(m),f.set(l(n.x,n.z),m);a.length;){a.sort((p,g)=>p.f-g.f);const d=a.shift(),y=l(d.x,d.z);if(d.x===o.x&&d.z===o.z){const p=[];let g=d;for(;g.parent;)p.push(te(g.x,g.z)),g=g.parent;return p.reverse()}r.add(y);for(let p=-1;p<=1;p++)for(let g=-1;g<=1;g++){if(g===0&&p===0)continue;const w=d.x+g,v=d.z+p;if(w<0||v<0||w>=c.width||v>=c.height||!N(w,v))continue;const x=l(w,v);if(r.has(x))continue;const Z=g===0||p===0?1:Math.SQRT2,J=Math.abs(c.cells[v][w].height-c.cells[d.z][d.x].height),G=d.g+Z+J;let S=f.get(x);S?G<S.g&&(S.g=G,S.parent=d,S.f=G+S.h):(S={x:w,z:v,g:G,h:O(w,v,o.x,o.z),f:0,parent:d},S.f=S.g+S.h,f.set(x,S),a.push(S))}}return null}function ne(){h=new s.Scene,h.fog=new s.FogExp2(8426917,.015),E=new s.PerspectiveCamera(70,window.innerWidth/window.innerHeight,.1,1200),E.position.set(0,62,68),I=new s.WebGLRenderer({antialias:!0}),I.setPixelRatio(Math.min(window.devicePixelRatio,2)),I.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(I.domElement),L=new _(E,I.domElement),L.enableDamping=!0,L.dampingFactor=.08,L.target.set(0,0,0),H=new s.Clock;const t=new s.AmbientLight(16777215,.55);h.add(t);const e=new s.DirectionalLight(16777215,.75);e.position.set(40,80,30),h.add(e);const n=new s.GridHelper(u.terrainSize,20,3355443,10066329);n.position.y=.02,h.add(n);const o=new s.Box3Helper(new s.Box3(new s.Vector3(-100/2,0,-100/2),new s.Vector3(u.terrainSize/2,0,u.terrainSize/2)),3355443);h.add(o),i.start=document.getElementById("startBattleBtn"),i.quick=document.getElementById("quickSkirmishBtn"),i.pause=document.getElementById("pauseBtn"),i.resume=document.getElementById("resumeBtn"),i.restart=document.getElementById("restartBtn"),i.resetCam=document.getElementById("resetCamBtn"),i.runtimeSpeed=document.getElementById("runtimeSpeed"),i.seed=document.getElementById("seedInput"),i.speedSlider=document.getElementById("speedSlider"),i.armySelection=document.getElementById("armySelection"),i.controls=document.getElementById("controls"),i.stats=document.getElementById("stats"),i.teamAStatus=document.getElementById("teamAStatus"),i.teamBStatus=document.getElementById("teamBStatus"),i.battleStatus=document.getElementById("battleStatus"),i.start.addEventListener("click",()=>$(F())),i.quick.addEventListener("click",()=>{document.getElementById("teamAWarriors").value=5,document.getElementById("teamAArchers").value=3,document.getElementById("teamAMages").value=2,document.getElementById("teamBWarriors").value=5,document.getElementById("teamBArchers").value=3,document.getElementById("teamBMages").value=2,$(F())}),i.pause.addEventListener("click",()=>{q=!0,i.pause.classList.add("hidden"),i.resume.classList.remove("hidden")}),i.resume.addEventListener("click",()=>{q=!1,i.resume.classList.add("hidden"),i.pause.classList.remove("hidden")}),i.restart.addEventListener("click",Se),i.resetCam.addEventListener("click",()=>{E.position.set(0,62,68),L.target.set(0,0,0)}),i.runtimeSpeed.addEventListener("input",a=>T=parseFloat(a.target.value)),i.speedSlider.addEventListener("input",a=>T=parseFloat(a.target.value)),i.seed.addEventListener("change",a=>{V=parseInt(a.target.value||"42",10),A=W(V)}),window.addEventListener("resize",oe),K(),X()}function oe(){E.aspect=window.innerWidth/window.innerHeight,E.updateProjectionMatrix(),I.setSize(window.innerWidth,window.innerHeight)}function K(){i.armySelection.classList.remove("hidden"),i.controls.classList.add("hidden"),i.stats.classList.add("hidden"),D=!1,q=!1,i.pause.classList.remove("hidden"),i.resume.classList.add("hidden"),Y()}function F(){return{A:{guerrero:parseInt(document.getElementById("teamAWarriors").value||"0",10),arquero:parseInt(document.getElementById("teamAArchers").value||"0",10),mago:parseInt(document.getElementById("teamAMages").value||"0",10)},B:{guerrero:parseInt(document.getElementById("teamBWarriors").value||"0",10),arquero:parseInt(document.getElementById("teamBArchers").value||"0",10),mago:parseInt(document.getElementById("teamBMages").value||"0",10)}}}function ae(t){const e=t.A.guerrero+t.A.arquero+t.A.mago,n=t.B.guerrero+t.B.arquero+t.B.mago;return e>=1&&n>=1}function $(t){if(!ae(t)){alert("Cada equipo debe tener al menos un NPC.");return}Y(!0),V=parseInt(i.seed.value||"42",10),A=W(V),i.armySelection.classList.add("hidden"),i.controls.classList.remove("hidden"),i.stats.classList.remove("hidden"),se(),ie(),le(t),U=performance.now(),q=!1,D=!0,i.battleStatus.textContent="Batalla en cursoâ€¦"}function se(){B&&(h.remove(B),M(B),B=null),ee();const t=new s.PlaneGeometry(u.terrainSize,u.terrainSize,64,64),e=t.attributes.position;for(let o=0;o<e.count;o++){const a=e.getX(o)*.08,r=e.getY(o)*.08,l=j(a,r)*4;e.setZ(o,l)}for(let o=0;o<c.height;o++)for(let a=0;a<c.width;a++){const r=(a/c.width-.5)*u.terrainSize,l=(o/c.height-.5)*u.terrainSize,f=j(r*.08,l*.08)*4;c.cells[o][a].height=f,c.cells[o][a].walkable=!0}e.needsUpdate=!0,t.computeVertexNormals();const n=new s.MeshStandardMaterial({color:7319151,roughness:1,metalness:0,flatShading:!1});B=new s.Mesh(t,n),B.rotation.x=-Math.PI/2,B.receiveShadow=!1,h.add(B)}function P(t,e){const n=Math.sin((t*127.1+e*311.7+V)*43758.5453);return n-Math.floor(n)}function re(t,e){const n=Math.floor(t),o=Math.floor(e),a=t-n,r=e-o;function l(w,v,x){return w+(v-w)*x}const f=P(n,o),m=P(n+1,o),d=P(n,o+1),y=P(n+1,o+1),p=l(f,m,a),g=l(d,y,a);return l(p,g,r)*2-1}function j(t,e){let n=0,o=1,a=1;for(let r=0;r<4;r++)n+=o*re(t*a,e*a),o*=.5,a*=2;return n}function ie(){const t=Math.floor(u.terrainSize*u.terrainSize*u.obstacleDensity);for(let e=0;e<t;e++){const n=A()>.5;let o,a,r;n?(o=new s.CylinderGeometry(.4,.6,4.8,8),a=new s.MeshStandardMaterial({color:9132587,roughness:1}),r=2.4):(o=new s.DodecahedronGeometry(1.2),a=new s.MeshStandardMaterial({color:8026746,roughness:1}),r=1.2);const l=new s.Mesh(o,a),f=(A()-.5)*u.terrainSize,m=(A()-.5)*u.terrainSize,d=0+r;l.position.set(f,d,m),l.userData.radius=n?1:1.2,h.add(l),C.push(l);const y=k(f,m),p=Math.ceil((l.userData.radius||1)/c.cellSize);for(let g=-p;g<=p;g++)for(let w=-p;w<=p;w++){const v=y.x+w,x=y.z+g;v>=0&&x>=0&&v<c.width&&x<c.height&&(c.cells[x][v].walkable=!1)}}}function le(t){z=[],b=[];const e=["A","B"],n={A:16731469,B:5078527},o={A:-100/3,B:u.terrainSize/3};e.forEach(a=>{const r=t[a];for(const l of u.npcTypes){const f=r[l]|0;for(let m=0;m<f;m++){const d=ce(a,l,n[a]),y=Math.floor(m/5),p=m%5;d.mesh.position.set(o[a]+(A()-.5)*6,1.1,y*2-8+p*1.6+(A()-.5)*1.5),h.add(d.mesh),z.push(d)}}})}function ce(t,e,n){const o=new s.Group,a=new s.Mesh(new s.SphereGeometry(1,16,16),new s.MeshStandardMaterial({color:n,roughness:.8}));o.add(a);const r=new s.Mesh(new s.BoxGeometry(2,.22,.22),new s.MeshBasicMaterial({color:2236962})),l=new s.Mesh(new s.BoxGeometry(1.98,.2,.2),new s.MeshBasicMaterial({color:65280})),f=new s.Group;f.add(r),f.add(l),f.position.set(0,1.6,0),l.position.x=-.99+.99,o.add(f);const m=u.attributes[e],d={vida:m.vida,vidaMax:m.vida,ataque:m.ataque,velocidad:m.velocidad,defensa:m.defensa,rango:m.rango,cadencia:m.cadencia};return{team:t,type:e,attributes:d,mesh:o,healthBar:l,healthBarGroup:f,target:null,status:"vivo",cooldown:0,path:null,pathIndex:0,pathTarget:null,pathEnd:null}}function X(){requestAnimationFrame(X);const t=Math.min(H.getDelta()*T,.05);L.update(),D&&!q&&(de(t),pe(t),ve());for(const e of z)e.healthBarGroup&&e.healthBarGroup.lookAt(E.position);I.render(h,E)}function de(t){for(const e of z){if(e.status!=="vivo"||((!e.target||e.target.status!=="vivo")&&(e.target=we(e),e.path=null),!e.target))continue;if(!e.path||e.pathTarget!==e.target||e.pathEnd&&e.pathEnd.distanceTo(e.target.mesh.position)>c.cellSize)e.path=R(e.mesh.position,e.target.mesh.position),e.pathIndex=0,e.pathTarget=e.target,e.pathEnd=e.target.mesh.position.clone();else if(e.path&&e.pathIndex<e.path.length){const a=e.path[e.pathIndex],r=k(a);N(r.x,r.z)||(e.path=R(e.mesh.position,e.target.mesh.position),e.pathIndex=0,e.pathEnd=e.target.mesh.position.clone())}e.mesh.position.distanceTo(e.target.mesh.position)<=e.attributes.rango?(e.path=null,he(e,e.target)):ue(e,t),ge(e)}}function ue(t,e){if(t.path&&t.pathIndex<t.path.length){const n=t.path[t.pathIndex],o=new s.Vector3().subVectors(n,t.mesh.position),a=o.length();if(a<.5)t.pathIndex++;else{o.normalize();const r=t.attributes.velocidad*e;t.mesh.position.addScaledVector(o,Math.min(r,a))}}else if(t.target){const n=new s.Vector3().subVectors(t.target.mesh.position,t.mesh.position).normalize(),o=t.attributes.velocidad*e;t.mesh.position.addScaledVector(n,o)}for(const n of C){const o=t.mesh.position.distanceTo(n.position),a=1.6+(n.userData.radius||1);if(o<a){const r=new s.Vector3().subVectors(t.mesh.position,n.position).normalize();t.mesh.position.addScaledVector(r,(a-o)*.6)}}t.mesh.position.clamp(new s.Vector3(-100/2,1.1,-100/2),new s.Vector3(u.terrainSize/2,1.1,u.terrainSize/2))}function me(t,e){const n=t.mesh.position,o=e.mesh.position,a=new s.Vector3().subVectors(o,n),r=a.lengthSq();for(const l of C){const f=new s.Vector3().subVectors(l.position,n),m=s.MathUtils.clamp(f.dot(a)/r,0,1);if(new s.Vector3().copy(a).multiplyScalar(m).add(n).distanceTo(l.position)<(l.userData.radius||1)+.6)return!1}return!0}function he(t,e){if(t.cooldown>0){t.cooldown-=H.getDelta()*T;return}t.attributes.rango>3&&!me(t,e)||(t.type==="guerrero"?Q(t,e,t.attributes.ataque):fe(t,e),t.cooldown=t.attributes.cadencia)}function Q(t,e,n){const o=Math.max(0,n-(e.attributes.defensa||0));e.attributes.vida-=o,e.attributes.vida<=0&&(e.status="muerto",h.remove(e.mesh))}function fe(t,e){const n=new s.SphereGeometry(u.projectile.radius,8,8),o=new s.MeshBasicMaterial({color:t.type==="mago"?11176191:2236962}),a=new s.Mesh(n,o);a.position.copy(t.mesh.position).add(new s.Vector3(0,.2,0));const r=new s.Vector3().subVectors(e.mesh.position,t.mesh.position).normalize();b.push({mesh:a,team:t.team,damage:t.attributes.ataque,vel:r.multiplyScalar(u.projectile.speed),ttl:2.5,target:e}),h.add(a)}function pe(t){for(let e=b.length-1;e>=0;e--){const n=b[e];if(n.mesh.position.addScaledVector(n.vel,t),n.ttl-=t,n.target&&n.target.status==="vivo"&&n.mesh.position.distanceTo(n.target.mesh.position)<1.1){Q({team:n.team},n.target,n.damage),h.remove(n.mesh),M(n.mesh),b.splice(e,1);continue}n.ttl<=0&&(h.remove(n.mesh),M(n.mesh),b.splice(e,1))}}function ge(t){const e=Math.max(0,t.attributes.vida/t.attributes.vidaMax);t.healthBar.scale.x=Math.max(.001,e),t.healthBar.position.x=-.99+.99*e;const n=.33*e;t.healthBar.material.color.setHSL(n,1,.5)}function we(t){let e=null,n=1/0;for(const o of z){if(o.team===t.team||o.status!=="vivo")continue;const a=t.mesh.position.distanceTo(o.mesh.position);a<n&&(n=a,e=o)}return e}function ve(){const t=z.filter(n=>n.team==="A"&&n.status==="vivo").length,e=z.filter(n=>n.team==="B"&&n.status==="vivo").length;if(i.teamAStatus.textContent=`Equipo A: ${t} vivos`,i.teamBStatus.textContent=`Equipo B: ${e} vivos`,t===0||e===0){const n=t>0?"Equipo A":"Equipo B",o=((performance.now()-U)/1e3).toFixed(2);i.battleStatus.textContent=`Ganador: ${n}. DuraciÃ³n: ${o}s`,q=!0,D=!1}}function Y(t){for(const e of z)h.remove(e.mesh),M(e.mesh);for(const e of b)h.remove(e.mesh),M(e.mesh);z.length=0,b.length=0;for(const e of C)h.remove(e),M(e);if(C.length=0,B&&(h.remove(B),M(B),B=null),t){const e=new Set;h.traverse(o=>{(o.type.includes("Light")||o instanceof s.GridHelper||o instanceof s.Box3Helper)&&e.add(o)});const n=[];h.children.forEach(o=>{e.has(o)||n.push(o)});for(const o of n)h.remove(o),M(o)}}function M(t){t&&t.traverse?.(e=>{e.geometry&&e.geometry.dispose?.(),e.material&&(Array.isArray(e.material)?e.material.forEach(n=>n.dispose?.()):e.material.dispose?.())})}function Se(){K()}ne();
