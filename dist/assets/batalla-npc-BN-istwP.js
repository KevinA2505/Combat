import*as a from"https://unpkg.com/three@0.179.1/build/three.module.js";import{OrbitControls as _}from"https://unpkg.com/three@0.179.1/examples/jsm/controls/OrbitControls.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const l of i.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function o(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(r){if(r.ep)return;r.ep=!0;const i=o(r);fetch(r.href,i)}})();(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function e(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(n){if(n.ep)return;n.ep=!0;const r=e(n);fetch(n.href,r)}})();const d={terrainSize:100,obstacleDensity:.05,npcTypes:["guerrero","arquero","mago"],attributes:{guerrero:{vida:100,ataque:20,velocidad:3,defensa:10,rango:2.2,cadencia:.7},arquero:{vida:80,ataque:14,velocidad:3.4,defensa:5,rango:9,cadencia:1.2},mago:{vida:60,ataque:26,velocidad:2.8,defensa:0,rango:7,cadencia:1.6}},projectile:{speed:16,radius:.18}};let h,x,b,A,H,S,z=[],G=[],I=[],s={},q=!1,U=0,k=1,T=!1,V=42;function W(t){return function(){t|=0,t=t+1831565813|0;let e=Math.imul(t^t>>>15,1|t);return e=e+Math.imul(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296}}let L=W(V),c=null;function ee(){const t=Math.floor(d.terrainSize/2),e=Math.floor(d.terrainSize/2);c={cellSize:2,width:t,height:e,cells:Array.from({length:e},()=>Array.from({length:t},()=>({height:0,walkable:!0})))}}function D(t,e){typeof t=="object"&&(e=t.z,t=t.x);const o=Math.floor((t+d.terrainSize/2)/c.cellSize),n=Math.floor((e+d.terrainSize/2)/c.cellSize);return{x:a.MathUtils.clamp(o,0,c.width-1),z:a.MathUtils.clamp(n,0,c.height-1)}}function te(t,e){const o=t*c.cellSize-d.terrainSize/2+c.cellSize/2,n=e*c.cellSize-d.terrainSize/2+c.cellSize/2,r=c.cells[e]?.[t]?.height||0;return new a.Vector3(o,r+1.1,n)}function O(t,e){return!!(c.cells[e]&&c.cells[e][t]&&c.cells[e][t].walkable)}function N(t,e,o,n){return Math.hypot(o-t,n-e)}function F(t,e){if(!c)return null;const o=D(t),n=D(e);if(!O(n.x,n.z))return null;const r=[],i=new Set,l=(m,B)=>`${m},${B}`,p=new Map,u={x:o.x,z:o.z,g:0,h:N(o.x,o.z,n.x,n.z),f:0,parent:null};for(u.f=u.h,r.push(u),p.set(l(o.x,o.z),u);r.length;){r.sort((f,g)=>f.f-g.f);const m=r.shift(),B=l(m.x,m.z);if(m.x===n.x&&m.z===n.z){const f=[];let g=m;for(;g.parent;)f.push(te(g.x,g.z)),g=g.parent;return f.reverse()}i.add(B);for(let f=-1;f<=1;f++)for(let g=-1;g<=1;g++){if(g===0&&f===0)continue;const v=m.x+g,w=m.z+f;if(v<0||w<0||v>=c.width||w>=c.height||!O(v,w))continue;const M=l(v,w);if(i.has(M))continue;const Z=g===0||f===0?1:Math.SQRT2,J=Math.abs(c.cells[w][v].height-c.cells[m.z][m.x].height),C=m.g+Z+J;let y=p.get(M);y?C<y.g&&(y.g=C,y.parent=m,y.f=C+y.h):(y={x:v,z:w,g:C,h:N(v,w,n.x,n.z),f:0,parent:m},y.f=y.g+y.h,p.set(M,y),r.push(y))}}return null}function ne(){h=new a.Scene,h.fog=new a.FogExp2(8426917,.015),x=new a.PerspectiveCamera(70,window.innerWidth/window.innerHeight,.1,1200),x.position.set(0,62,68),b=new a.WebGLRenderer({antialias:!0}),b.setPixelRatio(Math.min(window.devicePixelRatio,2)),b.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(b.domElement),A=new _(x,b.domElement),A.enableDamping=!0,A.dampingFactor=.08,A.target.set(0,0,0),H=new a.Clock;const t=new a.AmbientLight(16777215,.55);h.add(t);const e=new a.DirectionalLight(16777215,.75);e.position.set(40,80,30),h.add(e);const o=new a.GridHelper(d.terrainSize,20,3355443,10066329);o.position.y=.02,h.add(o);const n=new a.Box3Helper(new a.Box3(new a.Vector3(-100/2,0,-100/2),new a.Vector3(d.terrainSize/2,0,d.terrainSize/2)),3355443);h.add(n),s.start=document.getElementById("startBattleBtn"),s.quick=document.getElementById("quickSkirmishBtn"),s.pause=document.getElementById("pauseBtn"),s.resume=document.getElementById("resumeBtn"),s.restart=document.getElementById("restartBtn"),s.resetCam=document.getElementById("resetCamBtn"),s.runtimeSpeed=document.getElementById("runtimeSpeed"),s.seed=document.getElementById("seedInput"),s.speedSlider=document.getElementById("speedSlider"),s.armySelection=document.getElementById("armySelection"),s.controls=document.getElementById("controls"),s.stats=document.getElementById("stats"),s.teamAStatus=document.getElementById("teamAStatus"),s.teamBStatus=document.getElementById("teamBStatus"),s.battleStatus=document.getElementById("battleStatus"),s.start.addEventListener("click",()=>j($())),s.quick.addEventListener("click",()=>{document.getElementById("teamAWarriors").value=5,document.getElementById("teamAArchers").value=3,document.getElementById("teamAMages").value=2,document.getElementById("teamBWarriors").value=5,document.getElementById("teamBArchers").value=3,document.getElementById("teamBMages").value=2,j($())}),s.pause.addEventListener("click",()=>{q=!0,s.pause.classList.add("hidden"),s.resume.classList.remove("hidden")}),s.resume.addEventListener("click",()=>{q=!1,s.resume.classList.add("hidden"),s.pause.classList.remove("hidden")}),s.restart.addEventListener("click",ye),s.resetCam.addEventListener("click",()=>{x.position.set(0,62,68),A.target.set(0,0,0)}),s.runtimeSpeed.addEventListener("input",r=>k=parseFloat(r.target.value)),s.speedSlider.addEventListener("input",r=>k=parseFloat(r.target.value)),s.seed.addEventListener("change",r=>{V=parseInt(r.target.value||"42",10),L=W(V)}),window.addEventListener("resize",oe),K(),Q()}function oe(){x.aspect=window.innerWidth/window.innerHeight,x.updateProjectionMatrix(),b.setSize(window.innerWidth,window.innerHeight)}function K(){s.armySelection.classList.remove("hidden"),s.controls.classList.add("hidden"),s.stats.classList.add("hidden"),T=!1,q=!1,s.pause.classList.remove("hidden"),s.resume.classList.add("hidden"),Y()}function $(){return{A:{guerrero:parseInt(document.getElementById("teamAWarriors").value||"0",10),arquero:parseInt(document.getElementById("teamAArchers").value||"0",10),mago:parseInt(document.getElementById("teamAMages").value||"0",10)},B:{guerrero:parseInt(document.getElementById("teamBWarriors").value||"0",10),arquero:parseInt(document.getElementById("teamBArchers").value||"0",10),mago:parseInt(document.getElementById("teamBMages").value||"0",10)}}}function re(t){const e=t.A.guerrero+t.A.arquero+t.A.mago,o=t.B.guerrero+t.B.arquero+t.B.mago;return e>=1&&o>=1}function j(t){if(!re(t)){alert("Cada equipo debe tener al menos un NPC.");return}Y(!0),V=parseInt(s.seed.value||"42",10),L=W(V),s.armySelection.classList.add("hidden"),s.controls.classList.remove("hidden"),s.stats.classList.remove("hidden"),ae(),se(),le(t),U=performance.now(),q=!1,T=!0,s.battleStatus.textContent="Batalla en cursoâ€¦"}function ae(){S&&(h.remove(S),E(S),S=null),ee();const t=new a.PlaneGeometry(d.terrainSize,d.terrainSize,64,64),e=t.attributes.position;for(let n=0;n<e.count;n++){const r=e.getX(n)*.08,i=e.getY(n)*.08,l=R(r,i)*4;e.setZ(n,l)}for(let n=0;n<c.height;n++)for(let r=0;r<c.width;r++){const i=(r/c.width-.5)*d.terrainSize,l=(n/c.height-.5)*d.terrainSize,p=R(i*.08,l*.08)*4;c.cells[n][r].height=p,c.cells[n][r].walkable=!0}e.needsUpdate=!0,t.computeVertexNormals();const o=new a.MeshStandardMaterial({color:7319151,roughness:1,metalness:0,flatShading:!1});S=new a.Mesh(t,o),S.rotation.x=-Math.PI/2,S.receiveShadow=!1,h.add(S)}function P(t,e){const o=Math.sin((t*127.1+e*311.7+V)*43758.5453);return o-Math.floor(o)}function ie(t,e){const o=Math.floor(t),n=Math.floor(e),r=t-o,i=e-n;function l(v,w,M){return v+(w-v)*M}const p=P(o,n),u=P(o+1,n),m=P(o,n+1),B=P(o+1,n+1),f=l(p,u,r),g=l(m,B,r);return l(f,g,i)*2-1}function R(t,e){let o=0,n=1,r=1;for(let i=0;i<4;i++)o+=n*ie(t*r,e*r),n*=.5,r*=2;return o}function se(){const t=Math.floor(d.terrainSize*d.terrainSize*d.obstacleDensity);for(let e=0;e<t;e++){const o=L()>.5;let n,r,i;o?(n=new a.CylinderGeometry(.4,.6,4.8,8),r=new a.MeshStandardMaterial({color:9132587,roughness:1}),i=2.4):(n=new a.DodecahedronGeometry(1.2),r=new a.MeshStandardMaterial({color:8026746,roughness:1}),i=1.2);const l=new a.Mesh(n,r),p=(L()-.5)*d.terrainSize,u=(L()-.5)*d.terrainSize,m=0+i;l.position.set(p,m,u),l.userData.radius=o?1:1.2,h.add(l),G.push(l);const B=D(p,u),f=Math.ceil((l.userData.radius||1)/c.cellSize);for(let g=-f;g<=f;g++)for(let v=-f;v<=f;v++){const w=B.x+v,M=B.z+g;w>=0&&M>=0&&w<c.width&&M<c.height&&(c.cells[M][w].walkable=!1)}}}function le(t){z=[],I=[];const e=["A","B"],o={A:16731469,B:5078527},n={A:-100/3,B:d.terrainSize/3};e.forEach(r=>{const i=t[r];for(const l of d.npcTypes){const p=i[l]|0;for(let u=0;u<p;u++){const m=ce(r,l,o[r]),B=Math.floor(u/5),f=u%5;m.mesh.position.set(n[r]+(L()-.5)*6,1.1,B*2-8+f*1.6+(L()-.5)*1.5),h.add(m.mesh),z.push(m)}}})}function ce(t,e,o){const n=new a.Group,r=new a.Mesh(new a.SphereGeometry(1,16,16),new a.MeshStandardMaterial({color:o,roughness:.8}));n.add(r);const i=new a.Mesh(new a.BoxGeometry(2,.22,.22),new a.MeshBasicMaterial({color:2236962})),l=new a.Mesh(new a.BoxGeometry(1.98,.2,.2),new a.MeshBasicMaterial({color:65280})),p=new a.Group;p.add(i),p.add(l),p.position.set(0,1.6,0),l.position.x=-.99+.99,n.add(p);const u=d.attributes[e],m={vida:u.vida,vidaMax:u.vida,ataque:u.ataque,velocidad:u.velocidad,defensa:u.defensa,rango:u.rango,cadencia:u.cadencia};return{team:t,type:e,attributes:m,mesh:n,healthBar:l,healthBarGroup:p,target:null,status:"vivo",cooldown:0,path:null,pathIndex:0,pathTarget:null,pathEnd:null}}function Q(){requestAnimationFrame(Q);const t=Math.min(H.getDelta()*k,.05);A.update(),T&&!q&&(de(t),fe(t),we());for(const e of z)e.healthBarGroup&&e.healthBarGroup.lookAt(x.position);b.render(h,x)}function de(t){for(const e of z)if(!(e.status!=="vivo"||((!e.target||e.target.status!=="vivo")&&(e.target=ve(e),e.path=null),!e.target))){if(!e.path||e.pathTarget!==e.target||e.pathEnd&&e.pathEnd.distanceTo(e.target.mesh.position)>c.cellSize)e.path=F(e.mesh.position,e.target.mesh.position),e.pathIndex=0,e.pathTarget=e.target,e.pathEnd=e.target.mesh.position.clone();else if(e.path&&e.pathIndex<e.path.length){const o=e.path[e.pathIndex],n=D(o);O(n.x,n.z)||(e.path=F(e.mesh.position,e.target.mesh.position),e.pathIndex=0,e.pathEnd=e.target.mesh.position.clone())}e.mesh.position.distanceTo(e.target.mesh.position)<=e.attributes.rango?(e.path=null,he(e,e.target)):ue(e,t),ge(e)}}function ue(t,e){if(t.path&&t.pathIndex<t.path.length){const o=t.path[t.pathIndex],n=new a.Vector3().subVectors(o,t.mesh.position),r=n.length();if(r<.5)t.pathIndex++;else{n.normalize();const i=t.attributes.velocidad*e;t.mesh.position.addScaledVector(n,Math.min(i,r))}}else if(t.target){const o=new a.Vector3().subVectors(t.target.mesh.position,t.mesh.position).normalize(),n=t.attributes.velocidad*e;t.mesh.position.addScaledVector(o,n)}for(const o of G){const n=t.mesh.position.distanceTo(o.position),r=1.6+(o.userData.radius||1);if(n<r){const i=new a.Vector3().subVectors(t.mesh.position,o.position).normalize();t.mesh.position.addScaledVector(i,(r-n)*.6)}}t.mesh.position.clamp(new a.Vector3(-100/2,1.1,-100/2),new a.Vector3(d.terrainSize/2,1.1,d.terrainSize/2))}function me(t,e){const o=t.mesh.position,n=e.mesh.position,r=new a.Vector3().subVectors(n,o),i=r.lengthSq();for(const l of G){const p=new a.Vector3().subVectors(l.position,o),u=a.MathUtils.clamp(p.dot(r)/i,0,1);if(new a.Vector3().copy(r).multiplyScalar(u).add(o).distanceTo(l.position)<(l.userData.radius||1)+.6)return!1}return!0}function he(t,e){if(t.cooldown>0){t.cooldown-=H.getDelta()*k;return}t.attributes.rango>3&&!me(t,e)||(t.type==="guerrero"?X(t,e,t.attributes.ataque):pe(t,e),t.cooldown=t.attributes.cadencia)}function X(t,e,o){const n=Math.max(0,o-(e.attributes.defensa||0));e.attributes.vida-=n,e.attributes.vida<=0&&(e.status="muerto",h.remove(e.mesh))}function pe(t,e){const o=new a.SphereGeometry(d.projectile.radius,8,8),n=new a.MeshBasicMaterial({color:t.type==="mago"?11176191:2236962}),r=new a.Mesh(o,n);r.position.copy(t.mesh.position).add(new a.Vector3(0,.2,0));const i=new a.Vector3().subVectors(e.mesh.position,t.mesh.position).normalize();I.push({mesh:r,team:t.team,damage:t.attributes.ataque,vel:i.multiplyScalar(d.projectile.speed),ttl:2.5,target:e}),h.add(r)}function fe(t){for(let e=I.length-1;e>=0;e--){const o=I[e];if(o.mesh.position.addScaledVector(o.vel,t),o.ttl-=t,o.target&&o.target.status==="vivo"&&o.mesh.position.distanceTo(o.target.mesh.position)<1.1){X({team:o.team},o.target,o.damage),h.remove(o.mesh),E(o.mesh),I.splice(e,1);continue}o.ttl<=0&&(h.remove(o.mesh),E(o.mesh),I.splice(e,1))}}function ge(t){const e=Math.max(0,t.attributes.vida/t.attributes.vidaMax);t.healthBar.scale.x=Math.max(.001,e),t.healthBar.position.x=-.99+.99*e;const o=.33*e;t.healthBar.material.color.setHSL(o,1,.5)}function ve(t){let e=null,o=1/0;for(const n of z){if(n.team===t.team||n.status!=="vivo")continue;const r=t.mesh.position.distanceTo(n.mesh.position);r<o&&(o=r,e=n)}return e}function we(){const t=z.filter(o=>o.team==="A"&&o.status==="vivo").length,e=z.filter(o=>o.team==="B"&&o.status==="vivo").length;if(s.teamAStatus.textContent=`Equipo A: ${t} vivos`,s.teamBStatus.textContent=`Equipo B: ${e} vivos`,t===0||e===0){const o=t>0?"Equipo A":"Equipo B",n=((performance.now()-U)/1e3).toFixed(2);s.battleStatus.textContent=`Ganador: ${o}. DuraciÃ³n: ${n}s`,q=!0,T=!1}}function Y(t){for(const e of z)h.remove(e.mesh),E(e.mesh);for(const e of I)h.remove(e.mesh),E(e.mesh);z.length=0,I.length=0;for(const e of G)h.remove(e),E(e);if(G.length=0,S&&(h.remove(S),E(S),S=null),t){const e=new Set;h.traverse(n=>{(n.type.includes("Light")||n instanceof a.GridHelper||n instanceof a.Box3Helper)&&e.add(n)});const o=[];h.children.forEach(n=>{e.has(n)||o.push(n)});for(const n of o)h.remove(n),E(n)}}function E(t){t&&t.traverse?.(e=>{e.geometry&&e.geometry.dispose?.(),e.material&&(Array.isArray(e.material)?e.material.forEach(o=>o.dispose?.()):e.material.dispose?.())})}function ye(){K()}ne();
